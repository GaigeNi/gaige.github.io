<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息队列 | GaigeNi</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="TypeScript4 最新官方文档翻译">
    
    <link rel="preload" href="/assets/css/0.styles.11ecb3a6.css" as="style"><link rel="preload" href="/assets/js/app.222e11bd.js" as="script"><link rel="preload" href="/assets/js/2.e2584ff1.js" as="script"><link rel="preload" href="/assets/js/3.09efbb47.js" as="script"><link rel="prefetch" href="/assets/js/10.aaae9ce2.js"><link rel="prefetch" href="/assets/js/11.766f1150.js"><link rel="prefetch" href="/assets/js/12.0c98d878.js"><link rel="prefetch" href="/assets/js/13.fe01a633.js"><link rel="prefetch" href="/assets/js/14.15f9ea4b.js"><link rel="prefetch" href="/assets/js/15.35332c81.js"><link rel="prefetch" href="/assets/js/16.22292a10.js"><link rel="prefetch" href="/assets/js/4.ea165027.js"><link rel="prefetch" href="/assets/js/5.3913a566.js"><link rel="prefetch" href="/assets/js/6.5c61f787.js"><link rel="prefetch" href="/assets/js/7.75ef010f.js"><link rel="prefetch" href="/assets/js/8.3626fc99.js"><link rel="prefetch" href="/assets/js/9.627dd83b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.11ecb3a6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">GaigeNi</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GaigeNi的博客" class="dropdown-title"><span class="title">GaigeNi的博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="GaigeNi的博客" class="mobile-dropdown-title"><span class="title">GaigeNi的博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/GaigeNi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/GaigeNi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GaigeNi的博客" class="dropdown-title"><span class="title">GaigeNi的博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="GaigeNi的博客" class="mobile-dropdown-title"><span class="title">GaigeNi的博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/GaigeNi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/GaigeNi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="消息队列"><a href="#消息队列" class="header-anchor">#</a> 消息队列</h1> <h2 id="_1-消息中间件概述"><a href="#_1-消息中间件概述" class="header-anchor">#</a> 1. 消息中间件概述</h2> <h3 id="_1-1-队列"><a href="#_1-1-队列" class="header-anchor">#</a> 1.1 队列</h3> <p><strong>队列</strong>的主要作用是<strong>消除高并发访问高峰，加快网站的响应速度</strong></p> <p>在不使用消息队列的情况下，用户的请求数据直接写入数据库，在高并发的情况下，会对数据库造成巨大的压力，同时也使得系统响应延迟加剧</p> <h3 id="_1-2-消息中间件"><a href="#_1-2-消息中间件" class="header-anchor">#</a> 1.2 消息中间件</h3> <p>MQ全称为<strong>Message Queue</strong>， 消息队列(MQ)是一种应用程序对应用程序的通信方法。</p> <p>介绍：消息队列就是基础数据结构中的“先进先出”的一种数据机构。想一下，生活中买东西，需要排队，先排的人先买消费，就是典型的“先进先出”。</p> <p><img src="/assets/img/image-20221014131057865.4ad4bfb1.png" alt="image-20221014131057865"></p> <p>**消息传递：**指的是程序之间通过消息发送数据进行通信，而不是通过直接调用彼此来通信，直接调用通常是用于诸如远程过程调用的技术。</p> <p>**排队：**指的是应用程序通过队列来通信。</p> <p><strong>业务场景说明：</strong></p> <p>消息队列在大型电子商务类网站，如京东、淘宝、去哪儿等网站有着深入的应用，为什么会产生消息队列？有几个原因：</p> <p>不同进程（process）之间传递消息时，两个进程之间<strong>耦合</strong>程度过高，改动一个进程，引发必须修改另一个进程，为了<strong>隔离</strong>这两个进程，在两进程间抽离出一层（一个模块），所有两进程之间传递的消息，都必须通过消息队列来传递，单独修改某一个进程，不会影响另一个；</p> <p>不同进程（process）之间传递消息时，为了实现标准化，将消息的格式规范化了，并且，某一个进程接受的<strong>消息太多</strong>，一下子无法处理完，并且也有先后顺序，必须对收到的消息<strong>进行排队</strong>，因此诞生了事实上的消息队列；</p> <p>在项目中，可将一些无需即时返回且耗时的操作提取出来，进行<strong>异步处理</strong>，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而<strong>提高</strong>了<strong>系统</strong>的<strong>吞吐量</strong>。</p> <h3 id="_1-3-应用场景"><a href="#_1-3-应用场景" class="header-anchor">#</a> 1.3 应用场景</h3> <ol><li><p>解耦服务</p></li> <li><p>异步处理</p></li> <li><p>流量削峰</p></li></ol> <p>以上三点是我们使用消息中间件的最主要的目的</p> <h4 id="什么是qps-pv"><a href="#什么是qps-pv" class="header-anchor">#</a> 什么是QPS，PV?**</h4> <p>QPS即每秒查询率，是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。</p> <p>每秒查询率</p> <p>因特网上，经常用每秒查询率来衡量域名系统服务器的机器的性能，即为QPS。</p> <p>或者理解：每秒的响应请求数，也即是最大吞吐能力。</p> <p>计算关系</p> <p>QPS = 并发量 / 平均响应时间</p> <p>并发量 = QPS * 平均响应时间</p> <p>原理：每天80%的访问集中在20%的时间里，这20%时间叫做峰值时间。</p> <p>公式：( 总PV数 * 80% ) / ( 每天秒数 * 20% ) = 峰值时间每秒请求数(QPS) 。</p> <p>机器：峰值时间每秒QPS / 单台机器的QPS = 需要的机器</p> <h4 id="什么是pv-uv-pr"><a href="#什么是pv-uv-pr" class="header-anchor">#</a> 什么是PV ， UV ， PR?</h4> <p>① 什么是pv</p> <p><strong>PV(page view)</strong>，即页面浏览量，或点击量；通常是衡量一个网络新闻频道或网站甚至一条网络新闻的主要指标。</p> <p>对pv的解释是，一个访问者在24小时(0点到24点)内到底看了你网站几个页面。这里需要强调：同一个人浏览你网站同一个页面，不重复计算pv量，点100次也算1次。说白了，pv就是一个访问者打开了你的几个页面。</p> <p>PV之于网站，就像收视率之于电视，从某种程度上已成为投资者衡量商业网站表现的最重要尺度。</p> <p>pv的计算：当一个访问者访问的时候，记录他所访问的页面和对应的IP，然后确定这个IP今天访问了这个页面没有。如果你的网站到了23点，单纯IP有60万条的话，每个访问者平均访问了3个页面，那么pv表的记录就要有180万条。</p> <p>② 什么是uv
<strong>uv(unique visitor)</strong>，指访问某个站点或点击某条新闻的不同IP地址的人数。</p> <p>在同一天内，uv只记录第一次进入网站的具有独立IP的访问者，在同一天内再次访问该网站则不计数。独立IP访问者提供了一定时间内不同观众数量的统计指标，而没有反应出网站的全面活动。</p> <p>③ 什么是ＰＲ值
　PR值，即<strong>PageRank</strong>，网页的级别技术，用来标识网页的等级/重要性。级别从1到10级，10级为满分。PR值越高说明该网页越受欢迎（越重要）。</p> <p>例如：一个PR值为1的网站表明这个网站不太具有流行度，而PR值为7到10则表明这个网站非常受欢迎（或者说极其重要）。</p> <h3 id="_1-4-amqp和jms区别"><a href="#_1-4-amqp和jms区别" class="header-anchor">#</a> 1.4 AMQP和JMS区别</h3> <p>MQ是消息通信的模型；实现MQ的大致有两种主流方式：AMQP、JMS</p> <p><strong>AMQP</strong></p> <p>AMQP是一种<strong>高级消息队列协议（****Advanced Message Queuing Protocol）</strong>，更准确的说是一种binary wire-level protocol（<strong>链接协议</strong>）。这是其和JMS的本质差别，AMQP不从API层进行限定，而是直接定义网络交换的数据格式</p> <p><strong>JMS</strong></p> <p>JMS即**Java消息服务（JavaMessage Service）**应用程序接口，是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信</p> <p><strong>AMQP 和 JMS 区别</strong></p> <ul><li>JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过规定协议来统一数据交互的格式</li> <li>JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。</li> <li>JMS规定了两种消息模式；而AMQP的消息模式更加丰富</li></ul> <h3 id="_1-5-消息队列产品"><a href="#_1-5-消息队列产品" class="header-anchor">#</a> 1.5 消息队列产品</h3> <ul><li>ActiveMQ：基于JMS</li> <li>ZeroMQ：基于C语言开发</li> <li>Rabbitmq:基于AMQP协议，erlang语言开发，稳定性好</li> <li>RocketMQ：基于JMS，阿里巴巴产品</li> <li>Kafka：类似MQ的产品；分布式消息系统，高吞吐量</li></ul> <p><img src="/assets/img/image-20221014133721076.a37e44df.png" alt="image-20221014133721076"></p> <h3 id="_1-6-rabbitmq"><a href="#_1-6-rabbitmq" class="header-anchor">#</a> 1.6 RabbitMQ</h3> <p>RabbitMQ是由erlang语言开发，基于AMQP（Advanced Message Queue 高级消息队列协议）协议实现的消息队列，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。</p> <p>RabbitMQ官方地址：http://www.rabbitmq.com/</p> <p>RabbitMQ提供了<strong>6种模式</strong>：简单模式，work模式，Publish/Subscribe发布与订阅模式，Routing路由模式，Topics主题模式，RPC远程调用模式（远程调用，不太算MQ；暂不作介绍）</p> <p>官网对应模式介绍：https://www.rabbitmq.com/getstarted.html</p> <p><img src="/assets/img/image-20221014134342044.7cbbe24e.png" alt="image-20221014134342044"></p> <p>RabbitMQ 基础架构如下图：</p> <p><img src="/assets/img/clip_image002.1a427e35.gif" alt="img"></p> <p><strong>RabbitMQ 中的相关概念</strong></p> <p>Broker：接收和分发消息的应用，RabbitMQ Server就是 Message Broker</p> <p>Virtual host:出于多租户和安全因素设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 namespace 概念。当多个不同的用户使用同一个 RabbitMQ server 提供的服务时，可以划分出多个vhost，每个用户在自己的  vhost  创建 exchange／queue 等</p> <p>Connection： publisher／consumer 和 broker 之间的 TCP 连接</p> <p>Channel：如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个thread创建单独的 channel 进行通讯，AMQP method 包含了channel id 帮助客户端和message broker 识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销</p> <p>Exchange： message 到达 broker 的第一站，根据分发规则，匹配查询表中的 routing key，分发消息到queue 中去。常用的类型有：<strong>direct (point-to-point)</strong>， <strong>topic (publish-subscribe)</strong> and <strong>fanout (multicast)</strong></p> <p>Queue：存储消息的容器，消息最终被送到这里，等待 consumer 取走</p> <p>Binding： exchange 和 queue 之间的虚拟连接，binding 中可以包含 routing key。Binding 信息被保存到 exchange 中的查询表中，用于 message 的分发依据</p> <h2 id="_2-rabbitmq"><a href="#_2-rabbitmq" class="header-anchor">#</a> 2. RabbitMQ</h2> <p><strong>知识</strong></p> <ul><li>消息队列的作用</li> <li>RabbitMQ 消息队列
<ul><li>生产消费模型</li> <li>交换机模型</li> <li>死信队列</li> <li>延迟队列</li> <li>消息持久化</li> <li>Java 操作</li> <li>集群搭建</li></ul></li></ul> <p>通过docker安装RabbitMQ</p> <p>然后本地连接</p> <p>o  关闭防火墙：systemctl stop firewalld.service</p> <p>o  在web浏览器中输入地址：http://虚拟机ip:15672/</p> <p>o  输入默认账号密码： guest ： guest，guest用户默认不允许远程连接。</p> <p><img src="/assets/img/image-20221014171538326.091b6a8e.png" alt="image-20221014171538326"></p> <ul><li><p>overview：概览</p></li> <li><p>connections：无论生产者还是消费者，都需要与RabbitMQ建立连接后才可以完成消息的生产和消费，在这里可以查看连接情况</p></li> <li><p>channels：通道，建立连接后，会形成通道，消息的投递获取依赖通道。</p></li> <li><p>Exchanges：交换机，用来实现消息的路由</p></li> <li><p>Queues：队列，即消息队列，消息存放在队列中，等待消费，消费后被移除队列。</p></li></ul> <p><strong>端口：</strong></p> <ul><li><p>5672：rabbitMq的编程语言客户端连接端口</p></li> <li><p>15672：rabbitMq管理界面端口</p></li> <li><p>25672：rabbitMq集群的端口</p></li></ul> <p><strong>RabbitMQ运转流程</strong></p> <h3 id="_2-1-简单模式"><a href="#_2-1-简单模式" class="header-anchor">#</a> 2.1 简单模式</h3> <p>rabbitmq-Producer</p> <ul><li>生产者发送消息</li></ul> <ol><li>生产者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker；</li> <li>声明队列并设置属性；如是否排它，是否持久化，是否自动删除；</li> <li>将路由键（空字符串）与队列绑定起来；</li> <li>发送消息至RabbitMQ Broker；</li> <li>关闭信道；</li> <li>关闭连接；</li></ol> <p>rabbitmq-consumer</p> <ul><li>消费者接收消息</li></ul> <ol><li>消费者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker</li> <li>向Broker 请求消费相应队列中的消息，设置相应的回调函数；</li> <li>等待Broker投递响应队列中的消息，消费者接收消息；</li> <li>确认（ack，自动确认）接收到的消息；</li> <li>RabbitMQ从队列中删除相应已经被确认的消息；</li> <li>关闭信道；</li> <li>关闭连接；</li></ol> <p><img src="/assets/img/image-20221014192918365.14a82ef6.png" alt="image-20221014192918365"></p> <h3 id="_2-2-work工作队列模式"><a href="#_2-2-work工作队列模式" class="header-anchor">#</a> 2.2 Work工作队列模式</h3> <p><img src="/assets/img/image-20221014213030893.629d2453.png" alt="image-20221014213030893"></p> <p>**<code>Work Queues</code>**与入门程序的<code>简单模式</code>相比，多了一个或一些消费端，多个消费端共同消费同一个队列中的消息。</p> <p><strong>应用场景</strong>：对于 任务过重或任务较多情况使用工作队列可以<strong>提高任务处理的速度</strong></p> <h3 id="_2-3-publish-subscribe发布与订阅模式-广播模式"><a href="#_2-3-publish-subscribe发布与订阅模式-广播模式" class="header-anchor">#</a> 2.3 Publish/Subscribe发布与订阅模式 - 广播模式</h3> <p><img src="/assets/img/image-20221014213926386.7c1d4ff4.png" alt="image-20221014213926386"></p> <ul><li><p>P：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</p></li> <li><p>C：消费者，消息的接受者，会一直等待消息到来。</p></li> <li><p>Queue：消息队列，接收消息、缓存消息。</p></li> <li><p>Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。<strong>Exchange</strong><em>有常见以下</em><em>3种类型</em>*：</p></li> <li><ul><li>Fanout：<strong>广播</strong>，将消息交给所有绑定到交换机的队列</li> <li>Direct：<strong>定向</strong>，把消息交给符合指定routing key 的队列</li> <li>Topic：<strong>通配符</strong>，把消息交给符合routing pattern（路由模式） 的队列</li></ul></li> <li><p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失</p></li></ul> <hr> <p><img src="/assets/img/image-20221014214343445.b5d7b0c1.png" alt="image-20221014214343445"></p> <p>发布订阅模式：
1、每个消费者监听自己的队列。
2、生产者将消息发给broker，由交换机将消息转发到绑定此交换机的每个队列，每个绑定交换机的队列都将接收
到消息</p> <p>启动时候先启动 提供者  然后启动消费者</p> <h3 id="_2-4-routing路由模式"><a href="#_2-4-routing路由模式" class="header-anchor">#</a> 2.4 Routing路由模式</h3> <p><img src="/assets/img/image-20221014215329910.e06f5dee.png" alt="image-20221014215329910"></p> <p>图解：</p> <ul><li>P：生产者，向Exchange发送消息，发送消息时，会指定一个routing key。</li> <li>X：Exchange（交换机），接收生产者的消息，然后把消息递交给 与routing key完全匹配的队列</li> <li>C1：消费者，其所在队列指定了需要routing key 为 error 的消息</li> <li>C2：消费者，其所在队列指定了需要routing key 为 info、error、warning 的消息</li></ul> <h3 id="_2-5-topics通配符模式-主题交换机"><a href="#_2-5-topics通配符模式-主题交换机" class="header-anchor">#</a> 2.5 Topics通配符模式 - 主题交换机</h3> <p><img src="/assets/img/image-20221014220352135.e9ccc373.png" alt="image-20221014220352135"></p> <p><img src="index/image-20221014220407226.png" alt="image-20221014220407226"></p> <p><code>#</code>：匹配零个或多个词</p> <p><code>*</code>：匹配不多不少恰好1个词</p> <p>图解：</p> <ul><li>红色Queue：绑定的是<code>usa.#</code> ，因此凡是以 <code>usa.</code>开头的<code>routing key</code> 都会被匹配到</li> <li>黄色Queue：绑定的是<code>#.news</code> ，因此凡是以 <code>.news</code>结尾的 <code>routing key</code> 都会被匹配</li></ul> <h3 id="模式总结"><a href="#模式总结" class="header-anchor">#</a> 模式总结</h3> <p>RabbitMQ工作模式：
<strong>1</strong>、简单模式 <strong>HelloWorld</strong>
一个生产者、一个消费者，不需要设置交换机（使用默认的交换机）</p> <p><img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAwADAAAD/2wBDAAoHBwkHBgoJCAkLCwoMDxkQDw4ODx4WFxIZJCAmJSMgIyIoLTkwKCo2KyIjMkQyNjs9QEBAJjBGS0U+Sjk/QD3/2wBDAQsLCw8NDx0QEB09KSMpPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT3/wAARCACyAmQDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD2aiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAoWutWV7qd1YQS7rm1x5qY+7mr9eVw6++ifErxDFbWjXV3cBPLjXvj3reg8c6jZ3sUfiHR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" alt="img"></p> <p><strong>2</strong>、工作队列模式 <strong>Work Queue</strong>
一个生产者、多个消费者（竞争关系），不需要设置交换机（使用默认的交换机）</p> <p><img src="/assets/img/clip_image004.8ad6b0fa.jpg" alt="img"></p> <p><strong>3</strong>、发布订阅模式 <strong>Publish/subscribe</strong>
需要设置类型为fanout的交换机，并且交换机和队列进行绑定，当发送消息到交换机后，交换机会将消息发送到绑定的队列</p> <p><img src="/assets/img/clip_image006.8be83d2d.jpg" alt="img"></p> <p><strong>4</strong>、路由模式 <strong>Routing</strong>
需要设置类型为direct的交换机，交换机和队列进行绑定，并且指定routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列</p> <p><img src="/assets/img/clip_image008.c6e6a6c4.jpg" alt="img"></p> <p><strong>5</strong>、通配符模式 <strong>Topic</strong>
需要设置类型为topic的交换机，交换机和队列进行绑定，并且指定通配符方式的routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列</p> <p><img src="/assets/img/clip_image010.4df602e8.jpg" alt="img"></p> <h2 id="_3-rabbitmq高级特性"><a href="#_3-rabbitmq高级特性" class="header-anchor">#</a> 3. RabbitMQ高级特性</h2> <h3 id="_3-1-消息的可靠投递"><a href="#_3-1-消息的可靠投递" class="header-anchor">#</a> 3.1 消息的可靠投递</h3> <p>在使用 RabbitMQ 的时候，作为消息发送方希望<strong>杜绝任何消息丢失</strong>或者<strong>投递失败</strong>场景。RabbitMQ 为我们提供了<strong>两种方式</strong>用来<strong>控制消息的投递可靠性模式</strong>。</p> <ul><li><p>confirm 确认模式</p></li> <li><p>return 退回模式</p></li></ul> <h4 id="consumenr-ack"><a href="#consumenr-ack" class="header-anchor">#</a> Consumenr ACK</h4> <h3 id="_3-2-消费端限流"><a href="#_3-2-消费端限流" class="header-anchor">#</a> 3.2 消费端限流</h3> <p><img src="/assets/img/image-20221015111648376.99a47f81.png" alt="image-20221015111648376"></p> <p>在消费端创建 QoSListener</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>listener<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">ChannelAwareMessageListener</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Consumer 限流机制
 *  1. 确保消息被确认。不确认是不继续处理其他消息的
 *  2. listener-container配置属性
 *  prefetch = 1,表示消费端每次从mq拉去一条消息来消费,直到手动确认消费完毕后,才会继续拉取下一条消息。
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QosListener</span> <span class="token keyword">implements</span> <span class="token class-name">ChannelAwareMessageListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//1.获取消息</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_3-3-ttl"><a href="#_3-3-ttl" class="header-anchor">#</a> 3.3 TTL</h3> <p>TTL 全称 Time To Live（存活时间/过期时间）。</p> <p>当消息到达存活时间后，还没有被消费，会被自动清除。</p> <p>RabbitMQ可以对<strong>消息</strong>设置过期时间，也可以对整个**队列（Queue）**设置过期时间。</p> <p><img src="/assets/img/image-20221015112401969.0b2a7aea.png" alt="image-20221015112401969"></p> <p><strong>队列统一过期</strong></p> <p>修改 <code>rabbitmq-producer-spring</code> 项目的 配置文件 <code>spring-rabbitmq-producer.xml</code></p> <h3 id="_3-4-死信队列"><a href="#_3-4-死信队列" class="header-anchor">#</a> 3.4 死信队列</h3> <p>死信队列，英文缩写：DLX 。DeadLetter Exchange（死信交换机），当消息成为Dead message后，可以被重新发送到另一个交换机，这个交换机就是DLX。</p> <p><strong>什么是死信队列</strong></p> <p>先从概念解释上搞清楚这个定义，死信，顾名思义就是无法被消费的消息，字面意思可以这样理解，一般来说，producer将消息投递到broker或者直接到queue里了，consumer从queue取出消息进行消费，但某些时候由于特定的原因导致queue中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信，有死信，自然就有了死信队列；</p> <p><img src="/assets/img/image-20221015125730266.604b2383.png" alt="image-20221015125730266"></p> <p><strong>消息成为死信的三种情况：</strong></p> <ol><li><p>队列消息数量到达限制；比如队列最大只能存储10条消息，而发了11条消息，根据先进先出，<strong>最先发的消息会进入死信队列。</strong></p></li> <li><p>消费者拒接消费消息，basicNack/basicReject，并且不把消息重新放入原目标队列，requeue=false；</p></li> <li><p>原队列存在消息过期设置，消息到达超时时间未被消费；</p></li></ol> <p><strong>死信的处理方式</strong></p> <p>死信的产生既然不可避免，那么就需要从实际的业务角度和场景出发，对这些死信进行后续的处理，常见的处理方式大致有下面几种，</p> <p>① <strong>丢弃</strong>，如果不是很重要，可以选择丢弃</p> <p>② 记录死信<strong>入库</strong>，然后做后续的业务分析或处理</p> <p>③ 通过<strong>死信队列</strong>，由负责监听死信的应用程序进行处理</p> <p>综合来看，更常用的做法是第三种，即通过死信队列，将产生的死信通过程序的配置路由到指定的死信队列，然后应用监听死信队列，对接收到的死信做后续的处理，</p> <p><strong>队列绑定死信交换机</strong></p> <p>给队列设置参数： <strong>x-dead-letter-exchange</strong> 和 <strong>x-dead-letter-routing-key</strong></p> <p><img src="/assets/img/image-20221015130036365.981dde79.png" alt="image-20221015130036365"></p> <p><strong>死信队列小结</strong></p> <ol><li><p>死信交换机和死信队列和普通的没有区别</p></li> <li><p>当消息成为死信后，如果该队列绑定了死信交换机，则消息会被死信交换机重新路由到死信队列</p></li> <li><p>消息成为死信的三种情况：</p> <ul><li><p>队列消息长度（数量）到达限制；</p></li> <li><p>消费者拒接消费消息，并且不重回队列；</p></li> <li><p>原队列存在消息过期设置，消息到达超时时间未被消费；</p></li></ul></li></ol> <h3 id="_3-5-延迟队列"><a href="#_3-5-延迟队列" class="header-anchor">#</a> 3.5 延迟队列</h3> <p>延迟队列存储的对象肯定是对应的延时消息，所谓”延时消息”是指当消息被发送以后，并不想让消费者立即拿到消息，而是等待指定时间后，消费者才拿到这个消息进行消费。</p> <p>场景：在订单系统中，一个用户下单之后通常有30分钟的时间进行支付，如果30分钟之内没有支付成功，那么这个订单将进行取消处理。这时就可以使用延时队列将订单信息发送到延时队列。</p> <p>需求：</p> <ol><li><p>下单后，30分钟未支付，取消订单，回滚库存。</p></li> <li><p>新用户注册成功30分钟后，发送短信问候。</p></li></ol> <p><strong>实现方式</strong></p> <ol><li>延迟队列</li></ol> <p><img src="/assets/img/image-20221015132659632.6bff5679.png" alt="image-20221015132659632"></p> <ol start="2"><li>RabbitMQ 未提供延迟队列功能</li></ol> <p>但是可以通过： TTL+死信队列 组合实现延迟队列的效果</p> <p><img src="/assets/img/image-20221015132834252.b8cdfd70.png" alt="image-20221015132834252"></p> <p>生产者发送消息到 TTL队列中， 不设置消费者， 30分钟过了之后， 会通过死信交换机进入死信队列， 库存系统从死信队列中， 取出信息判断订单状态。</p> <p>消费者 监听的<strong>死信队列</strong> 而不是 TTL队列</p> <h2 id="_4-消息百分百成功投递"><a href="#_4-消息百分百成功投递" class="header-anchor">#</a> 4. 消息百分百成功投递</h2> <p><img src="/assets/img/image-20221015133927154.ecdb9dcd.png" alt="image-20221015133927154"></p> <p>Step 1： 首先把消息信息(业务数据）存储到数据库中，紧接着，我们再把这个消息记录也存储到一张消息记录表里（或者另外一个同源数据库的消息记录表）</p> <p>Step 2：发送消息到MQ Broker节点（采用confirm方式发送，会有异步的返回结果）</p> <p>Step 3、4：生产者端接受MQ Broker节点返回的Confirm确认消息结果，然后进行更新消息记录表里的消息状态。比如默认Status = 0 当收到消息确认成功后，更新为1即可！</p> <p>Step 5：但是在消息确认这个过程中可能由于网络闪断、MQ Broker端异常等原因导致 回送消息失败或者异常。这个时候就需要发送方（生产者）对消息进行可靠性投递了，保障消息不丢失，100%的投递成功！（有一种极限情况是闪断，Broker返回的成功确认消息，但是生产端由于网络闪断没收到，这个时候重新投递可能会造成消息重复，需要消费端去做幂等处理）所以我们需要有一个定时任务，（比如每5分钟拉取一下处于中间状态的消息，当然这个消息可以设置一个超时时间，比如超过1分钟 Status = 0 ，也就说明了1分钟这个时间窗口内，我们的消息没有被确认，那么会被定时任务拉取出来）</p> <p>Step 6：接下来我们把中间状态的消息进行重新投递 retry send，继续发送消息到MQ ，当然也可能有多种原因导致发送失败</p> <p>Step 7：我们可以采用设置最大努力尝试次数，比如投递了3次，还是失败，那么我们可以将最终状态设置为Status = 2 ，最后 交由人工解决处理此类问题（或者把消息转储到失败表中）。</p> <h2 id="_5-消息幂等性保障"><a href="#_5-消息幂等性保障" class="header-anchor">#</a> 5. 消息幂等性保障</h2> <p>幂等性指一次和多次请求某一个资源,对于资源本身应该具有同样的结果。也就是说,其任意多次执行对资源本身所产生的影响均与一次执行的影响相同。</p> <p><img src="/assets/img/image-20221015135119644.918ec6f0.png" alt="image-20221015135119644"></p> <p>在MQ中指,消费多条相同的消息,得到与消费该消息一次相同的结果</p> <p><strong>消息幂等性保障</strong> <strong>乐观锁机制</strong></p> <p>生产者发送消息：</p> <div class="language- extra-class"><pre class="language-text"><code>id=1,money=500,version=1
</code></pre></div><p>消费者接收消息</p> <div class="language- extra-class"><pre class="language-text"><code>id=1,money=500,version=1
id=1,money=500,version=1
</code></pre></div><p>消费者需要保证幂等性：第一次执行SQL语句</p> <div class="language- extra-class"><pre class="language-text"><code>第一次执行：version=1
update account set money = money - 500 , version = version + 1
where id = 1 and version = 1
</code></pre></div><p>消费者需要保证幂等性：第二次执行SQL语句</p> <div class="language- extra-class"><pre class="language-text"><code>第二次执行：version=2
update account set money = money - 500 , version = version + 1
where id = 1 and version = 1
</code></pre></div><h2 id="_6-rabbitmq集群搭建"><a href="#_6-rabbitmq集群搭建" class="header-anchor">#</a> 6. RabbitMQ集群搭建</h2> <h2 id="面试"><a href="#面试" class="header-anchor">#</a> 面试</h2> <ol><li>使用消息队列有哪些优缺点？</li> <li>如何保证消息消费的幂等性？</li> <li>消息队列有哪些路由模型？</li> <li>你是否用过消息队列，解决过什么问题？</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.222e11bd.js" defer></script><script src="/assets/js/2.e2584ff1.js" defer></script><script src="/assets/js/3.09efbb47.js" defer></script>
  </body>
</html>
